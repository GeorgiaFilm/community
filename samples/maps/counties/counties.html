<html>
<head>
<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
<style>
  body {
    margin: 0px;
  }
  .map {
    width:100%;
    height: 100%;
    }
  .info {
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      background: white;
      background: rgba(255,255,255,0.8);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
  }
  .info h4 {
      margin: 0 0 5px;
      color: #777;
  }
</style>

<!--
TO DO: Move leaflet and topo .js files locallly.
-->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script src="../../../js/d3/d3.v5.min.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>

<script type="text/javascript" src="../../../js/common/showdown.min.js"></script>
<script type="text/javascript" src="../../../js/jquery/zepto.min.js"></script>
<script type="text/javascript" src="../../../js/common/navigation.js"></script>
<script type="text/javascript" src="../../../js/common/common.js"></script>
<link rel="stylesheet" href="../../../css/display.css" />

</head>
<body>
<div id="header"></div>
<div style="height:60px"></div>

    <!--
    BEA Arts Data
    https://nasaa-arts.org/nasaa_research/creative-economy-state-profiles/
    -->

    <!--
     Source: http://bl.ocks.org/mpmckenna8/af23032b41f0ea1212563b523e859228
     -->
    <div class="map" id="mapcon"><br><br>&nbsp; &nbsp; &nbsp; &nbsp; L O A D I N G &nbsp; M A P</div>

    <script type="text/javascript">

    var neighbors;
    var topodata = {};
    var geojson;
    //var co = d3.scaleOrdinal(d3.schemeCategory20b); // Stopped working when switching from v4 to v5.
    
    //var co = d3.scaleOrdinal(); // Nice blue, but no rainbow

    var co = d3.scaleOrdinal(d3.schemeCategory10); // More muted blue


    // Similar to maps/poverty
    // Get colors for map regions
    var region = d3.map();
    var promises = [

      // CSV file contains: name,county_num,economic_region,wia_region
      d3.csv("topo/GA_county_regions.csv", function(d) { 
        // Should name or county_num be related?
        region.set(d.name, +d.economic_region); /* Prepending + converts to number */
      })

    ]
    Promise.all(promises).then(ready)

    function ready([us]) {
      //alert(region["Chattahoochee"])


      /// moved here from window.onload
            var neighbors

            function style(feat, i){
                var i = feat.indie;

                var coco1 = co(feat.color = d3.max(neighbors[i], function(n) {
                  return topodata.features[n].color; 
                }) + 1 | 0);


                // STATEFP":"13","COUNTYFP":

                console.log("feat: " + feat.indie); // 0 to 158

                //console.log("feat.COUNTYFP " + feat.COUNTYFP);

                //var coco = co(feat.color = region.get(feat.indie));
                var coco = co(feat.indie);

                return {
                    fillColor: coco,
                    fillOpacity: .3,
                    weight: .3
                }
             }

            var req = new XMLHttpRequest();
                // Topo data source
                //https://github.com/deldersveld/topojson/tree/master/countries/us-states
                var url = 'topo/GA-13-georgia-counties.json'

                    req.open('GET', url, true);
                    req.onreadystatechange = handler;
                    req.send();

                var topoob = {};
                topodata = {};
                function handler(){

                if(req.readyState === XMLHttpRequest.DONE){

                  //// USA
                  //var lat = 38.3;
                  //var lon = -96.5;
                  //var zoom = 5;

                  // Georgia
                  var lat = 32.16;
                  var lon = -82.90;
                  var zoom = 7;

                  var layer = "terrain";

                  var map = new L.Map('mapcon',
                  {
                      scrollWheelZoom:false,
                      center: new L.LatLng(lat,lon),
                      zoom: zoom
                  });

                  var OpenStreetMap_BlackAndWhite = L.tileLayer('//{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                      maxZoom: 18,
                      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                  });

                  map.addLayer( OpenStreetMap_BlackAndWhite)//new L.StamenTileLayer(layer));
                  // try and catch json parsing of the responseText
                  //try {
                        topoob = JSON.parse(req.responseText)

                        // Originated in community/map/leaflet/zips-sm.html
                        // zips_us_topo.json
                        // {"type":"Topology","objects":{"data":{"type":"GeometryCollection","geometries":[{"type":"Polygon

                        // {"type":"Topology","transform":{"scale":[0.00176728378633945,0.0012459509163533049],"translate":

                        //"arcs":[[38,39,40,41,42]],"type":"Polygon","properties":{"STATEFP":"13","COUNTYFP":"003","COUNTYNS":"00345784","AFFGEOID":"0500000US13003","GEOID":"13003","NAME":"Atkinson","LSAD":"06","ALAND":879043416,"AWATER":13294218}}

                        //neighbors = topojson.neighbors(topoob.objects.data.geometries);
                        neighbors = topojson.neighbors(topoob.arcs); // .properties

                        // ADD geometries  see https://observablehq.com/@d3/choropleth
                        //topodata = topojson.feature(topoob, topoob.objects.data)

                        //topodata = topojson.feature(topoob, topoob.transform)
                        topodata = topojson.feature(topoob, topoob.objects.cb_2015_georgia_county_20m)

                        //topodata.features = topodata.features.map(function(fm,i){
                        topodata.features = topodata.features.map(function(fm,i){
                            var ret = fm;
                            //console.log("fm: " + fm.COUNTYFP);
                            ret.indie = i;
                            return ret
                          });
                        geojson = L.geoJson(topodata, {style:style, onEachFeature: onEachFeature})
                    .addTo(map);
                        console.log('neigh', neighbors)
                     //}
                    //catch(e){
                    //  geojson = {};
                    //   console.log(e)
                    //}
                    console.log(topodata)

            /* Rollover effect */
            function highlightFeature(e){
              var layer = e.target;
              layer.setStyle({
                weight: 3,
                  color: '#665',
                dashArray: '',
                fillOpacity: .7})
                 if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                              layer.bringToFront();
                             }
              // Send text to side box
              info.update(layer.feature.properties);
            }

            function resetHighlight(e){
              geojson.resetStyle(e.target);
              info.update();
            }

            function zoomToFeature(e) {
                map.fitBounds(e.target.getBounds());
            }

            function onEachFeature(feature, layer){
              layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight, 
                    click: zoomToFeature
              })
            }


            var info = L.control();
            info.onAdd = function(map) {
                this._div = L.DomUtil.create('div', 'info');
                this.update();
                return this._div;
            }

            info.update = function(props){
                // National
                //this._div.innerHTML = "<h4>Zip code</h4>" + (props ? props.zip + '</br>' + props.name + ' ' + props.state + '</br>' : "Hover over map")
                
                this._div.innerHTML = "<h4>County</h4>" + (props ? props.NAME + "<br>" : "Hover over map<br>") + (props ? props.COUNTYFP : "")
                

                // TO fix if using state - id is not defined
                // Also, other state files may need to have primary node renamed to "data"
                //this._div.innerHTML = "<h4>Zip code</h4>" + (1==1 ? id + '</br>' : "Hover over map")
            }

            info.addTo(map);



          }
       }

      /// end moved

    }




		window.onload = function () {

      // Moved to function ready so regions are availble.

      // TO DO: Try moving tile loading portion back here for fast initial display.
        
   }


  </script>
<link rel="stylesheet" href="../../../css/material_icons.css" />
</body>
</html>
