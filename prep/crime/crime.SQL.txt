-- To run: sqlite3 crime.db < crime.SQL.txt > crime.OUT.txt

-- Setup
.headers on
.separator ','

drop table if exists crime;
drop table if exists zipcodes;
drop table if exists county_to_FIPS;
drop table if exists FIPS_to_zip;
drop view if exists combine_zipcode;


-- ***** ***** ***** ***** ***** ***** ***** ***** ***** ***** --

-- (a.i) Create tables

CREATE table crime
(
	State,
	County,
	ViolentCrime,
	MurderNonnegligentManslaughter,
	Rape1,
	Robbery,
	AggravatedAssault,
	PropertyCrime,
	Burglary,
	LarcenyTheft,
	MotorVehicleTheft,
	Arson2,
	Area,
	StateAbbrev
);

CREATE table county_to_FIPS
(
	fips int,
	Name varchar(255),
	State varchar(255)
);

CREATE table FIPS_to_zip -- county_zip.csv
(
	county int,
	zip int,
	res_ratio float,
	bus_ratio float,
	oth_ratio float,
	tot_ratio float
);

CREATE table zipcodes
(
	 GEOID int,
	 ALAND	int,
	 AWATER int,
	 ALAND_SQMI	int,
	 AWATER_SQMI int,
	 latitude int,
	 longitude int  
);


--import csv
.mode csv
.import ./output/2017/2017_crime_counties.csv crime

.mode csv
.import ../zipcodes/county/county_fips.csv county_to_FIPS

.mode csv
.import ../zipcodes/county/county_zip.csv FIPS_to_zip


-- Display table info
.tables
.print '~~~~~'

-- This is tab deliminited.
.mode csv
.import ../zipcodes/2018_Gaz_zcta_national.csv zipcodes

.headers off
SELECT COUNT(*) as totalRows FROM crime;
.headers on
.print '~~~~~'

create index StateAbbrev_index ON crime (StateAbbrev);
create index GEOID_index on county_to_FIPS(State); 
create index zip_index ON FIPS_to_zip (zip); -- The zip code


--combine zipcode

Create view combine_zipcode
as 
select zipcodes.GEOID zip, 
zipcodes.latitude, zipcodes.longitude,
crime.StateAbbrev,
crime.County,
crime.PropertyCrime,
crime.ViolentCrime
from crime 

-- TO DO after abbreviation added:
inner join county_to_FIPS
on crime.StateAbbrev = county_to_FIPS.State and crime.County = county_to_FIPS.Name

inner join FIPS_to_zip
on county_to_FIPS.FIPS = FIPS_to_zip.county

inner join zipcodes  
on FIPS_to_zip.zip=zipcodes.GEOID
;


--convert to csv
.mode csv
.output output/2017/2017_crime_zip.csv
select * from combine_zipcode;
.output stdout


drop table if exists crime;
drop table if exists zipcodes;
drop table if exists county_to_FIPS;
drop table if exists FIPS_to_zip;
drop view if exists combine_zipcode;